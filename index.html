DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Robotex by jfcloutier</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Robotex</h1>
      <h2 class="project-tagline">Adventures in robotics with Mindstorm EV3 and Elixir</h2>
      <a href="https://github.com/jfcloutier/robotex" class="btn">View on GitHub</a>
      <a href="https://github.com/jfcloutier/robotex/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/jfcloutier/robotex/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="june-19-2015" class="anchor" href="#june-19-2015" aria-hidden="true"><span class="octicon octicon-link"></span></a>June 19, 2015</h1>

<p>First things first: All Hail <a href="http://www.elixirconf.eu/elixirconf2015/torben-hoffmann">Torben Hoffmann</a>! Torben is pioneering the use of Elixir to control Mindstorm robots. His <a href="https://www.youtube.com/watch?v=C8SZaV96_vk">talk</a> is what got me fired up. Torben generously <a href="https://twitter.com/LeHoff/status/611789138342342656">offered to help</a> as I stumble along. (Thank you!)</p>

<p>I ordered Lego Mindstorm EV3 kit and a microSD card. They arrived yesterday. <img src="ev3.jpg" alt="ev3"></p>

<p>As soon as I can pry the EV3 from the hands of my 12 year-old son Will, I will follow the instructions from Torben's <a href="http://www.elixirconf.eu/static/upload/media/14382623667112154elixirconflego.pdf">Elixir Conf 2015 slides</a> and:</p>

<ol>
<li>Install the <a href="http://www.ev3dev.org/">ev3dev</a> Linux kernel with EV3 hardware drivers</li>
<li>Install Erlang and Elixir on the card</li>
<li>Install Torben's Elixir <a href="https://github.com/lehoff/ev3">EV3</a> and <a href="https://github.com/lehoff/ev3bt">EV3 Bluetooth</a> libraries</li>
<li>Boot the EV3 brick from the SD card.</li>
<li>Build a robot (with Will of course)</li>
<li>Write "hello robot" in Elixir and run it<br>
</li>
</ol>

<p>I will be working from my Lenovo G710 laptop running Ubuntu 14.04 </p>

<p>Let's see how easy or hard it will be for me to get there.</p>

<h2>Installing ev3dev on the EV3 brick</h2>
<p>Easy peasy. 30 minutes later: <img alt="ev3dev" src="images/ev3dev_ssh.png"/>

<h1><a id="june-22-2015" class="anchor" href="#june-22-2015" aria-hidden="true"><span class="octicon octicon-link"></span></a>June 22, 2015</h1>

<h2>Installing Erlang and Elixir</h2>

<p>Installing Erlang via <pre>apt-get install Erlang</pre> took about 2 hours (the brick with a microSD card is not exactly blazing fast) but went without a glitch.</p>

<p>I then installed Elixir from the <a class="anchor" href="http://elixir-lang.org/install.html#precompiled-package">pre-compiled package</a> by doing </p>

<pre>
  wget https://github.com/elixir-lang/elixir/releases/download/v1.0.4/Precompiled.zip
  apt-get install unzip
  mkdir /opt/elixir
  unzip Precompiled.zip -d /opt/elixir
</pre>

<p>and then adding /opt/elixir/bin to the PATH in my .bashrc by logging out root and logging in as myself (the ev3dev setup process had me add a user for myself)
and adding this at the end of my .bashrc</p>

<pre>
export ELIXIR=/opt/elixir 

PATH=$PATH:$ELIXIR/bin
</pre>

<p> and then doing <pre>source .bashrc</pre></p>

<p>That took very little time and now Elixir runs on the EV3. How cool is that? <img alt="elixir on ev3" src="images/ev3_iex.png"/></p>

<h2>Bluetooth woes</h2>

<p>I spent more hours than I care to admit trying to establish a network connection via Bluetooth. The first roadbloack was missing Bluetooth firmware on my laptop. I took me a while
to <a class="anchor" href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1242079"> figure this one out</a>. Once Bluetooth on my laptop was functional, I could successfully
pair my laptop's with the ev3dev over Bluetooth.</p>

<p>Next step was establishing a network connection over Bluetooth. For that, I needed to install <a class="anchor" href="https://apps.ubuntu.com/cat/applications/precise/blueman/">Bluetooth Manager</a>
on my laptop as <a class="anchor" href="http://www.ev3dev.org/docs/tutorials/connecting-to-the-internet-via-bluetooth/">instructed</a> and setup network settings. No problem.</p>

<p>This is where I ran into a roadblock I have yet to overcome. The "Network Connection" button in <img alt="network connection"  src="images/bluetooth-device-network-connection.png"/> won't do anything.
After googling the living daylight out of this, I suspect this may have to do with missing Bluetooth security permissions on my laptop. I have an idea on how to go about it but now, for some reason,
Ev3dev won't reboot. So I am re-initializing the microSD card with a fresh image and see how far I can get this time. This is frustrating.</p>

<p>In the meanwhile, Will is racing along building a robot and is having a grand old time. <img alt="will robot 1" src="images/will_robot_1.jpg"/>
<img alt="will robot 2" src="images/will_robot_2.jpg"/> </p>

<h1><a id="june-27-2015" class="anchor" href="#june-27-2015" aria-hidden="true"><span class="octicon octicon-link"></span></a>June 27, 2015</h1>

<h2> @&^%+%$ Bluetooth! </h2>

<p>After spending way too many hours trying to establish a Bluetooth connection between EV3DEV and Ubuntu 14.04 I gave up in disgust. I won't describe my many unsuccessful attempts. I  decided to try WiFi instead and I bought a USB WiFi dongle.</p>

<p> <img alt="wifi dongle" src="images/ev3_wifi.jpg"/></p>

<p>ev3dev recognized the WiFi dongle after a reboot and I thought the rest would be easy. Wrong. Entering my (long) WiFi password turned out to be an ordeal. The onscreen keyboard on the EV3 is barely usable and I had to race to beat a timeout - if I took too long, the EV3 would abort the process. I didn't want to change my password and reset all my devices. So it took me a good half-hour to hone my skills and beat the clock. I finally got a connection.</p>

<p>I can <strong>finally</strong> connect to the EV3 without a USB cable. </p>

<p>Yeah.</p>

<h2>Torben's NDC 2015 talk</h2>

<p>I watched Torben's <a href="https://vimeo.com/131639825"> NDC 2015 talk on Elixir and Mindstorm</a> where he bravely silences his inner chicken and gives a live demo of an Elixir-controlled robot. The demo gods smile upon him and it works! After my dispiriting battle with Bluetooth on Ubuntu, this rekindles my spirit.</p>

<p>I learned from his talk that the EV3 Elixir library is out-of-date with the latest release of ev3dev. I guess my next step is finding out how much of an upgrade is required.</p>

<h1><a id="august-17-2015" class="anchor" href="#August 17-2015" aria-hidden="true"><span class="octicon octicon-link"></span></a>August 17, 2015</h1>

<p>My son Will is in camp for two weeks (Robotics, Horse Camp) and has
   relinquished his death grip on the EV3. Time to make some progress with Elixir robotics!

<h2>Accessing the EV3 from Elixir</h2>

<p>I completed Elixir modules to...
<ul>
<li> interface with the EV3DEV's /sys/class/... file-interface to the EV3.</li>
<li> expose the tachomotors and sensors (color, infrared and touch) via a domain language </li>
</ul>
</p>

<p>You will find the code in my <a href="https://github.com/jfcloutier/ev3ex" class="anchor">EV3EX</a> public Github repository. Be warned! It is very much a work in progress.</p>

<p>Admin note: Make sure that the account you log into to execute your code on the EV3 brick belongs to the ev3dev group. Otherwise your code will fail with inufficient file permissions.</p>

<p>Unlike Torben, I eschewed the clever use of macros and opted instead for painstakingly hand-writing functions that hide the idiosycratic details of the EV3DEV interface. My goal was to expose the EV3 via pure functions, hiding as much as possible any file-based state and control.<p>

<p>Here are some usage examples:</p>

<h3>Tacho motor</h3>

<p><img alt="tacho motor" src="images/tachomotor_large.png"/></p>

<pre>
iex(1)> alias EV3.Tachomotor, as: TM
...
iex(2)> [motor|_] = TM. motors # Detect motors and hold on to the first one
[%EV3.Device{class: :tacho_motor,
  path: "/sys/class/tacho-motor/motor0", port: "outA",
  props: %{commands: ["run-forever", "run-to-abs-pos",
     "run-to-rel-pos", "run-timed", "run-direct", "stop", "reset"],
    controls: %{duty_cycle: 0, polarity: :normal, position: 0,
      ramp_down: 0, ramp_up: 0, speed: 0, speed_mode: nil,
      speed_regulation: :off, time: 0}, count_per_rot: 360,
    stop_commands: ["coast", "brake", "hold"]}, type: :large},
 %EV3.Device{class: :tacho_motor,
  path: "/sys/class/tacho-motor/motor1", port: "outB",
  props: %{commands: ["run-forever", "run-to-abs-pos",
     "run-to-rel-pos", "run-timed", "run-direct", "stop", "reset"],
    controls: %{duty_cycle: 0, polarity: :normal, position: 0,
      ramp_down: 0, ramp_up: 0, speed: 0, speed_mode: nil,
      speed_regulation: :off, time: 0}, count_per_rot: 360,
    stop_commands: ["coast", "brake", "hold"]}, type: :medium}]

iex(3)> motor = TM.set_speed(motor, :rps, 1) # Set motor speed to 1 rotation per second
...
iex(4)> TM.brake motor # Stop the motor quickly
...
iex(5)> motor = TM.reset # Reset the motor to its initial state
...
iex(6)> motor = motor |> TM.set_duty_cycle(50) |> TM.reverse_polarity # 50% power and in reverse
...
iex(7)> motor = TM.run_for(motor, 10000) # run for 10 secs
...
iex(8)> IO.puts TM.current_speed(motor, :dps) # Print the current speed in degrees per sec
360
iex(9)> TM.stalled? motor # Is the motor stalled?
false
</pre> 

<h3>Lego Sensors</h3>

<pre>
iex(10)> alias EV3.LegoSensor, as: LS
...
iex(11)> sensors = LS.sensors # Detect all connected sensors
[%EV3.Device{class: :sensor, path: "/sys/class/lego-sensor/sensor0",
  port: "in3", props: %{mode: "TOUCH"}, type: :touch},
 %EV3.Device{class: :sensor, path: "/sys/class/lego-sensor/sensor1",
  port: "in1", props: %{mode: "IR-REMOTE"}, type: :infrared},
 %EV3.Device{class: :sensor, path: "/sys/class/lego-sensor/sensor2",
  port: "in2", props: %{mode: "COL-COLOR"}, type: :color}]

iex(13)> ir = sensors |> Enum.find(&(LS.infrared? &1)) # Get an infrared sensor
%EV3.Device{class: :sensor, path: "/sys/class/lego-sensor/sensor1",
 port: "in1", props: %{mode: "IR-REMOTE"}, type: :infrared}

iex(14)> color_sensor = sensors |> Enum.find(&(LS.color? &1)) # Get a color sensor
...
iex(15)> touch = sensors |> Enum.find(&(LS.touch? &1)) # Get a touch sensor
...
</pre>

<h4>Infrared sensor</h4>

<p><img alt="infrared sensor" src="images/infrared_sensor.jpg"/></p>

<pre>
iex(16)> alias EV3.InfraredSensor, as: IR
...
iex(17)> ir = IR.set_proximity_mode(ir) # Set proximity mode
%EV3.Device{class: :sensor, path: "/sys/class/lego-sensor/sensor1",
 port: "in1", props: %{mode: "IR-PROX"}, type: :infrared}

iex(18)> IR.proximity(ir) # Get proximity of obstacle as percent of range                          
62
iex(19) ir = IR.set_seek_mode(ir) # Set beacon-seeking mode
%EV3.Device{class: :sensor, path: "/sys/class/lego-sensor/sensor1",
 port: "in1", props: %{mode: "IR-SEEK"}, type: :infrared}

iex(20) IR.seek_distance(ir, 1) # Get distance (as % of range) of beacon on channel 1
15
iex(21) IR.seek_heading(ir, 1) # Get heading of beacon on channel 1 (far left is -25)
-12
iex(22)> ir = IR.set_remote_mode(ir) # Set remote control mode
%EV3.Device{class: :sensor, path: "/sys/class/lego-sensor/sensor1",
 port: "in1", props: %{mode: "IR-REMOTE"}, type: :infrared}

iex(23)> IR.remote_buttons(ir, 1) # What buttons were pushed on remote set to channel 1?
%{blue: :down, red: :up}
</pre>

<h4>Color sensor</h4>

<p><img alt="color sensor" src="images/color_sensor.png"/></p>

<pre>
iex(24)> color_sensor = CS.set_reflect_mode(color_sensor)  # Set to reflected light detection mode         
%EV3.Device{class: :sensor, path: "/sys/class/lego-sensor/sensor2",
 port: "in2", props: %{mode: "COL-REFLECT"}, type: :color}

iex(25)> CS.reflected_light(color_sensor) # How much light is reflected from the sensor (in % of maximum)?
16
iex(26)> color_sensor = CS.set_ambient_mode(color_sensor) # Set to ambient light detection mode
%EV3.Device{class: :sensor, path: "/sys/class/lego-sensor/sensor2",
 port: "in2", props: %{mode: "COL-AMBIENT"}, type: :color}

iex(27)> CS.ambient_light(color_sensor) # How much ambient light is detected (in % of maximum)?
3
iex(28)> color_sensor = CS.set_color_mode(color_sensor) # Set to color detection mode
%EV3.Device{class: :sensor, path: "/sys/class/lego-sensor/sensor2",
 port: "in2", props: %{mode: "COL-COLOR"}, type: :color}

iex(29)>  CS.color(color_sensor) # What color is detected?
:blue
</pre>

<h4>Touch sensor</h4>

<p><img alt="touch sensor" src="images/touch_sensor.png"/></p>

<pre>
iex(30)> alias EV3.TouchSensor, as: TS
...
iex(31)> TS.pressed? touch
false
iex(32)> TS.released? touch
true
</pre>

<h2>Development process</h2>

<p>I do my work on a laptop running the latest stable releases of Ubuntu, Erlang and Elixir.</p>

<p>The EV3 brick is slow, at least compared to modern, multicore laptops. So I code on my laptop and deploy compiled Elixir code to the brick.</p>

<p><img alt="compile-deploy" src="images/ev3_compile_deploy.png"/></p>

<p>I use a shell script to quickly upload my code to the EV3 brick. 
It is defined in my laptop's .bashrc file:</p>

<pre>
alias deploy-ev3='pushd ~/projects; tar -cf ev3ex.tar --exclude="*.git" --exclude="*.*~" --exclude=".gitignore" ev3ex; scp ev3ex.tar jf@192.168.1.125:~jf/ev3ex.tar; popd'
</pre>

<p>I then unpack the code I uploaded to the brick.</p>

<p><img alt="install" src="images/install_ev3.png"/></p>

<p>I use the following shell script defined in my EV3 brick's .bashrc file:</p>

<pre>
alias install-ev3='pushd ~;rm -r ev3ex;tar -xvf ev3ex.tar;popd'
</pre>

<p>You will need to modify the scripts to fit your own context (ip address, user name, directories etc.)</p>

<p>Once I have uploaded and installed the latest code,  I launch the Elixir mix application on the EV3 and play around.</p>

<p><img alt="launch app" src="images/launch_app.png"/></p>

<h2>Recent purchases</h2>

<p>The EV3 kit was increasingly at risk of becoming dispersed throughout the house so I bought a 
<a href="http://www.amazon.com/gp/product/B000E3FKTE?ie=UTF8&tag=onlicort-20&linkCode=as2&camp=1789&creative=9325&creativeASIN=B000E3FKTE" class="anchor">Plano Tackle Box</a> 
tool organizer based on the recommendations from the <a href="http://www.brickengineer.com/pages/2007/10/09/storing-your-lego-collection/" class="anchor">Brick Engineer</a>.</p>

<p>Will volunteered to store the EV3 kit in the organizer and he did a great job. <img alt="tool organizer" src="images/plano_box.jpg"/></p>

<p>We went to Oregon for our summer vacation. In Portland (Or), we visited Powell's Books. Will found this fantastic book about robot-building <strong>idioms</strong> for the EV3.</p>

<p> <a href="http://www.amazon.com/The-LEGO-MINDSTORMS-Idea-Book/dp/1593276001"><img alt="ev3 book" src ="images/ev3_book.jpg"/></a></p>

<p>He is already exploring the many ideas in the book. I need to catch up with him!</p>

<p><img alt="ev3 book open" src="images/ev3_book_2.jpg"/></p>

     <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/jfcloutier/robotex">Robotex</a> is maintained by <a href="https://github.com/jfcloutier">jfcloutier</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

</section>
  
  </body>
</html>

